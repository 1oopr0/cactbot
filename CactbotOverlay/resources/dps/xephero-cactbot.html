<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>

    <!-- OverlayPlugin widget resize handle -->
    <link rel="stylesheet" href="../resize_handle.css">
    <script src="../resize_handle.js"></script>

    <script type="text/javascript" src="../lib/jquery/jquery-1.11.3.min.js"></script>

    <style>
        html {
            width: 100%;
            height: 100%;
        }
        body {
            margin: 0px;
            overflow: hidden;
        }
        .box {
            font-family: Tahoma;
            color: #ded7be;
            background-color: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 0px;
        }
        #overlay {
            margin-top: auto;
        }
        .title {
            display: flex;
            flex-direction: row;
        }
        .title .name {
            order: 1;
            align-self: flex-start;
            margin-right: auto;
        }
        .title .misses {
            flex-shrink: 0;
            order: 2;
            align-self: flex-end;
        }
        .title .number {
            flex-shrink: 0;
            order: 3;
            align-self: flex-end;
        }
        .phase {
            border-radius: 10px;
            font-size: 19px;
            text-align: right;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .phasename {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            order: -100;
        }
        .phasetotal {
            order: -99;
        }
        .number {
            margin-left: 3px;
            margin-right: 3px;
        }

        #topcontainer {
            width: 100%;
            display: flex;
        }

        #overlaysource {
            display: none;
        }
        #phasesource {
            display: none;
        }
        #phasenumbersource {
            display: none;
        }

        ol {
            list-style-type: none;
            margin: 0px;
        }

        li {
            height: 23px;
        }

        li .dps {
            display: inline-block;
            color: #ded7be;
            width: 75px;
            text-align: right;
            font-size: 19px;
        }

        li .name {
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        li .detail {
            display: inline-block;
            vertical-align: top;
            color: #ded7be;
            font-size: 12px;
            width: calc(100% - 80px);
        }

        li .detail .number {
            color: #ded7be;
        }

        li .detail .misses {
            font-weight: bold;
            font-size: 14px;
            margin-right: 5px;
            margin-left: 5px;
        }

        li .bar {
            display: block;
            height: 5px;
            background-color: #9d9165;
        }

        li.you {
            background-color: #5d5125;
        }

        .hide {
            display: none;
        }
    </style>
    <script type="text/javascript">
        $(function() {
            "use strict";

            var rows = 10;
            var rdps_max = 0;

            var cbData = {
                phases: [],
                phaseUpdates: [],
            };

            function hideOverlay() {
                $('#overlay').addClass('hide');
            }

            function showOverlay() {
                $('#overlay').removeClass('hide');
            }

            function update(e) {
                showOverlay();

                var encounter = e.detail.Encounter;
                var combatants = e.detail.Combatant;
                var template = $('#overlaysource li');
                var overlay = $('#overlay');
                var container = overlay.clone();
                // Reserve one row for the phase titles.
                var rows = Math.floor($(window).height() / template.height()) - 1;

                // todo: animate changes while combat is active?
                // for now, always just fully replace the content

                container.html('');

                var rdps = parseFloat(encounter.encdps);

                // sanity check
                if (!isNaN(rdps) && rdps != Infinity) {
                    rdps_max = Math.max(rdps_max, rdps);
                }

                var header = template.clone();
                if (encounter.encdps.length <= 7) {
                    header.find('.dps').text(encounter.encdps);
                } else {
                    header.find('.dps').text(encounter.ENCDPS);
                }

                header.find('.name').text(encounter.title);
                header.find('.number').text(encounter.duration);
                header.find('.bar').css('width', ((rdps / rdps_max) * 100) + '%');

                container.append(header);

                var limit = Math.max(combatants.length, rows);
                var names = Object.keys(combatants).slice(0,rows-1);
                var maxdps = false;

                for (var i = 0; i < names.length; i++) {
                    var combatant = combatants[names[i]];
                    var row = template.clone();

                    if (!maxdps) {
                        maxdps = parseFloat(combatant.encdps);
                    }

                    if (combatant.name == 'YOU') {
                        row.addClass('you');
                    }

                    row.find('.dps').text(combatant.encdps);
                    row.find('.name').text(combatant.Job.toUpperCase() + ' ' + combatant.name);
                    row.find('.number').text(combatant.damage);
                    row.find('.misses').text(combatant.misses > 0 ? '(' + combatant.misses + ')' : '');
                    row.find('.bar').css('width', ((parseFloat(combatant.encdps) / maxdps) * 100) + '%');

                    container.append(row);
                }

                overlay.replaceWith(container);

                var dpsOrder = {};
                for (var i = 0; i < names.length; ++i) {
                    dpsOrder[names[i]] = i;
                }

                for (var u = 0; u < cbData.phaseUpdates.length; ++u) {
                    var newPhase = cbData.phaseUpdates[u];
                    var found = false;
                    for (var p = 0; p < cbData.phases.length; ++p) {
                        var oldPhase = cbData.phases[p];
                        if (oldPhase.Phase.name === newPhase.Phase.name) {
                            // Update of existing phase, so remove old one and replace in place.
                            if (oldPhase.element) {
                                oldPhase.element.remove();
                            }
                            cbData.phases[p] = newPhase;
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        cbData.phases.push(newPhase);
                    }
                }
                cbData.phaseUpdates = [];

                for (var i = 0; i < cbData.phases.length; ++i) {
                    updatePhase(cbData.phases[i], dpsOrder);
                }
            }

            function updatePhase(phase, dpsOrder) {
                 var makeRow = function(name, dps) {
                    var row = $('#phasenumbersource li').clone();
                    row.find('.number').text(dps);
                    if (name == 'YOU') {
                        row.addClass('you');
                    }
                    return row;
                }

                if (!phase.element) {
                    var container = $('#phasesource ol').clone();
                    phase.element = container;

                    var phasename = container.find('.phasename');
                    phasename.text(phase.Phase.name);
                    var phasetotal = container.find('.phasetotal');
                    phasetotal.text(phase.Encounter.ENCDPS);
                    $('#topcontainer').append(container);

                    phase.elemMap = {};

                    var maxPhaseDPS = null;
                    for (var name in phase.Combatant) {
                        var combatant = phase.Combatant[name];
                        var row = makeRow(name, combatant.ENCDPS);
                        container.append(row);
                        phase.elemMap[name] = row;

                        if (!maxPhaseDPS || combatant.ENCDPS > maxPhaseDPS.dps) {
                            maxPhaseDPS = {
                                dps: combatant.ENCDPS,
                                row: row,
                            }
                        }
                    }
                    if (maxPhaseDPS) {
                        var element = maxPhaseDPS.row.find('.number');
                        element.css('text-decoration', 'underline');
                    }
                }

                // Sometimes new combatants get added (e.g. Limit Break)
                for (var name in dpsOrder) {
                    var element = phase.elemMap[name];
                    if (element !== undefined) {
                        continue;
                    }
                    var row = makeRow(name, 0);
                    phase.element.append(row);
                    phase.elemMap[name] = row;
                    console.error('adding late combatant: ' + name)
                }

                // Reorder phase numbers based on current (visible) dps order.
                for (var name in phase.elemMap) {
                    var element = phase.elemMap[name];
                    var order = dpsOrder[name];
                    if (order === undefined) {
                        element.addClass('hide');
                    } else {
                        element.removeClass('hide');
                        element.css('order', dpsOrder[name]);
                    }
                }
            }

            function clearPhases() {
                for (var i = 0; i < cbData.phases.length; ++i) {
                    var element = cbData.phases[i].element;
                    if (!element) {
                        continue;
                    }
                    element.remove();
                }
                cbData.phases = [];
                cbData.phaseUpdates = [];
            }

            function handleEvent(type, e) {
                if (type === 'onOverlayDataUpdate') {
                    // TODO: if duration goes back in time, clear phases
                    // Or potentially send "onFightStart" in those cases?
                    update(e);
                } else if (type === 'onFightStart') {
                    clearPhases();
                } else if (type === 'onFightEnd') {
                } else if (type === 'onOverlayPhaseUpdate') {
                    var phase = e.detail;
                    // Until we get a complete first phase, drop everything else on the ground.
                    if (cbData.phases.length != 0 || phase.complete) {
                        cbData.phaseUpdates.push(phase);
                    }
                } else if (type == 'onZoneChangedEvent') {
                    clearPhases();
                    hideOverlay();
                }
            }

            $(document).on('onOverlayDataUpdate', function(e) {
                handleEvent('onOverlayDataUpdate', e.originalEvent);
            });
            $(document).on('onZoneChangedEvent', function (e) {
                handleEvent('onZoneChangedEvent', e.originalEvent);
            });
            $(document).on('onFightStart', function (e) {
                handleEvent('onFightStart', e.originalEvent);
            });
            $(document).on('onFightEnd', function (e) {
                handleEvent('onFightEnd', e.originalEvent);
            });
            $(document).on('onOverlayPhaseUpdate', function (e) {
                handleEvent('onOverlayPhaseUpdate', e.originalEvent);
            });

            window.addEventListener('message', function(e) {
                handleEvent(e.data.type, e.data);
            });
        });
    </script>
</head>
<body>
<ol id="overlaysource">
    <li>
        <span class="dps"></span>
        <div class="detail">
            <span class="title">
                <span class="name"></span>
                <span class="number"></span>
                <span class="misses"></span>
            </span>
            <span class="bar"></span>
        </div>
    </li>
</ol>
<div id="phasesource">
    <ol class="phase box">
        <li><span class="phasename"></span></li>
        <li><span class="phasetotal number"></span></li>
    </ol>
</div>
<ol id="phasenumbersource">
    <li><span class="number"></span></li>
</ol>

<div id="topcontainer">
    <ol id="overlay" class="box"></ol>
</div>
</body>
</html>
